services:
  # PostgreSQL - Primary Database
  postgres:
    image: postgres:16-alpine
    container_name: pet-platform-postgres
    environment:
      POSTGRES_USER: ${DATABASE_USER}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      POSTGRES_DB: ${DATABASE_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infrastructure/database/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - pet-network
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER} -d ${DATABASE_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB - Chat & Logs
  mongodb:
    image: mongo:7
    container_name: pet-platform-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE}
    volumes:
      - mongo_data:/data/db
      - ./infrastructure/database/mongodb/init.js:/docker-entrypoint-initdb.d/init.js
    networks:
      - pet-network
    restart: always
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis - Cache & Sessions
  redis:
    image: redis:7-alpine
    container_name: pet-platform-redis
    volumes:
      - redis_data:/data
    networks:
      - pet-network
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ - Message Queue
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: pet-platform-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - pet-network
    restart: always
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 10s
      retries: 5

  # Elasticsearch - Search Engine
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: pet-platform-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - pet-network
    restart: always
    healthcheck:
      test:
        ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # MinIO - S3-compatible object storage
  minio:
    image: minio/minio:latest
    container_name: pet-platform-minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY}
    volumes:
      - minio_data:/data
    networks:
      - pet-network
    command: server /data --console-address ":9001"
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # API Gateway
  gateway:
    build:
      context: .
      dockerfile: ./backend/gateway/Dockerfile
    container_name: pet-platform-gateway
    ports:
      - "${GATEWAY_PORT}:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - USER_SERVICE_URL=${USER_SERVICE_URL}
      - PET_SERVICE_URL=${PET_SERVICE_URL}
      - MATCHING_SERVICE_URL=${MATCHING_SERVICE_URL}
      - CHAT_SERVICE_URL=${CHAT_SERVICE_URL}
      - MARKETPLACE_SERVICE_URL=${MARKETPLACE_SERVICE_URL}
      - ADMIN_SERVICE_URL=${ADMIN_SERVICE_URL}
      - CORS_ORIGIN=${CORS_ORIGIN}
    depends_on:
      - redis
      - rabbitmq
    networks:
      - pet-network
    restart: always

  # Auth Service
  auth-service:
    build:
      context: .
      dockerfile: ./backend/services/auth-service/Dockerfile
    container_name: pet-auth-service
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=${JWT_EXPIRATION}
      - RABBITMQ_URL=${RABBITMQ_URL}
      - CORS_ORIGIN=${CORS_ORIGIN}
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - pet-network
    restart: always

  # User & Profile Service
  user-service:
    build:
      context: .
      dockerfile: ./backend/services/user-service/Dockerfile
    container_name: pet-user-service
    environment:
      - NODE_ENV=production
      - PORT=3002
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - RABBITMQ_URL=${RABBITMQ_URL}
      - MINIO_ENDPOINT=${MINIO_ENDPOINT}
      - MINIO_PORT=${MINIO_PORT}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
    depends_on:
      - postgres
      - redis
      - rabbitmq
      - minio
    networks:
      - pet-network
    restart: always

  # Pet Service
  pet-service:
    build:
      context: .
      dockerfile: ./backend/services/pet-service/Dockerfile
    container_name: pet-pet-service
    environment:
      - NODE_ENV=production
      - PORT=3003
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - RABBITMQ_URL=${RABBITMQ_URL}
      - ELASTICSEARCH_NODE=${ELASTICSEARCH_NODE}
      - MINIO_ENDPOINT=${MINIO_ENDPOINT}
      - MINIO_PORT=${MINIO_PORT}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - ML_SERVICE_URL=${ML_RECOMMENDER_URL}
    depends_on:
      - postgres
      - redis
      - rabbitmq
      - elasticsearch
      - minio
    networks:
      - pet-network
    restart: always

  # Matching Service
  matching-service:
    build:
      context: .
      dockerfile: ./backend/services/matching-service/Dockerfile
    container_name: pet-matching-service
    environment:
      - NODE_ENV=production
      - PORT=3004
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - RABBITMQ_URL=${RABBITMQ_URL}
      - ML_SERVICE_URL=${ML_RECOMMENDER_URL}
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - pet-network
    restart: always

  # Chat Service
  chat-service:
    build:
      context: .
      dockerfile: ./backend/services/chat-service/Dockerfile
    container_name: pet-chat-service
    environment:
      - NODE_ENV=production
      - PORT=3005
      - MONGODB_URI=${MONGODB_URI}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - RABBITMQ_URL=${RABBITMQ_URL}
      - MINIO_ENDPOINT=${MINIO_ENDPOINT}
      - MINIO_PORT=${MINIO_PORT}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
    depends_on:
      - mongodb
      - redis
      - rabbitmq
      - minio
    networks:
      - pet-network
    restart: always

  # Marketplace Service
  marketplace-service:
    build:
      context: .
      dockerfile: ./backend/services/marketplace-service/Dockerfile
    container_name: pet-marketplace-service
    environment:
      - NODE_ENV=production
      - PORT=3006
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - RABBITMQ_URL=${RABBITMQ_URL}
      - ELASTICSEARCH_NODE=${ELASTICSEARCH_NODE}
      - MINIO_ENDPOINT=${MINIO_ENDPOINT}
      - MINIO_PORT=${MINIO_PORT}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
    depends_on:
      - postgres
      - redis
      - rabbitmq
      - elasticsearch
      - minio
    networks:
      - pet-network
    restart: always

  # Admin & Moderation Service
  admin-service:
    build:
      context: .
      dockerfile: ./backend/services/admin-service/Dockerfile
    container_name: pet-admin-service
    environment:
      - NODE_ENV=production
      - PORT=3007
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - MONGODB_URI=${MONGODB_URI}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - RABBITMQ_URL=${RABBITMQ_URL}
      - ML_SERVICE_URL=${ML_FRAUD_DETECTION_URL}
    depends_on:
      - postgres
      - mongodb
      - redis
      - rabbitmq
    networks:
      - pet-network
    restart: always

  # ML Recommender Service (Python FastAPI)
  ml-recommender:
    build:
      context: .
      dockerfile: ./ml-services/recommender/Dockerfile
    container_name: pet-ml-recommender
    environment:
      - ENVIRONMENT=production
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MODEL_PATH=/models
    depends_on:
      - postgres
      - redis
    networks:
      - pet-network
    volumes:
      - ml_models:/models
    restart: always

  # ML Fraud Detection Service (Python FastAPI)
  ml-fraud-detection:
    build:
      context: .
      dockerfile: ./ml-services/fraud-detection/Dockerfile
    container_name: pet-ml-fraud-detection
    environment:
      - ENVIRONMENT=production
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - MONGODB_URI=${MONGODB_URI}
      - MODEL_PATH=/models
    depends_on:
      - postgres
      - mongodb
    networks:
      - pet-network
    volumes:
      - ml_models:/models
    restart: always

  # Next.js Frontend
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
        NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL}
    container_name: pet-platform-frontend
    ports:
      - "3100:3100"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL}
    depends_on:
      - gateway
    networks:
      - pet-network
    restart: always

networks:
  pet-network:
    driver: bridge

volumes:
  postgres_data:
  mongo_data:
  redis_data:
  rabbitmq_data:
  elasticsearch_data:
  minio_data:
  ml_models:
