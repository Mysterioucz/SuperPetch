services:
    # PostgreSQL - Primary Database
    postgres:
        image: postgres:16-alpine
        container_name: pet-platform-postgres
        environment:
            POSTGRES_USER: petadmin
            POSTGRES_PASSWORD: petpass123
            POSTGRES_DB: pet_platform
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./infrastructure/database/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
        networks:
            - pet-network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U petadmin"]
            interval: 10s
            timeout: 5s
            retries: 5

    # MongoDB - Chat & Logs
    mongodb:
        image: mongo:7
        container_name: pet-platform-mongodb
        environment:
            MONGO_INITDB_ROOT_USERNAME: petadmin
            MONGO_INITDB_ROOT_PASSWORD: petpass123
            MONGO_INITDB_DATABASE: pet_platform_chat
        ports:
            - "27019:27017"
        volumes:
            - mongo_data:/data/db
            - ./infrastructure/database/mongodb/init.js:/docker-entrypoint-initdb.d/init.js
        networks:
            - pet-network
        healthcheck:
            test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
            interval: 10s
            timeout: 5s
            retries: 5

    # Redis - Cache & Sessions
    redis:
        image: redis:7-alpine
        container_name: pet-platform-redis
        ports:
            - "6379:6379"
        volumes:
            - redis_data:/data
        networks:
            - pet-network
        command: redis-server --appendonly yes --requirepass petredis123
        healthcheck:
            test: ["CMD", "redis-cli", "-a", "petredis123", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    # RabbitMQ - Message Queue
    rabbitmq:
        image: rabbitmq:3-management-alpine
        container_name: pet-platform-rabbitmq
        environment:
            RABBITMQ_DEFAULT_USER: petadmin
            RABBITMQ_DEFAULT_PASS: petpass123
        ports:
            - "5672:5672"
            - "15672:15672"
        volumes:
            - rabbitmq_data:/var/lib/rabbitmq
        networks:
            - pet-network
        healthcheck:
            test: rabbitmq-diagnostics -q ping
            interval: 30s
            timeout: 10s
            retries: 5

    # Elasticsearch - Search Engine
    elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
        container_name: pet-platform-elasticsearch
        environment:
            - discovery.type=single-node
            - xpack.security.enabled=false
            - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
        ports:
            - "9200:9200"
            - "9300:9300"
        volumes:
            - elasticsearch_data:/usr/share/elasticsearch/data
        networks:
            - pet-network
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "curl -f http://localhost:9200/_cluster/health || exit 1",
                ]
            interval: 30s
            timeout: 10s
            retries: 5

    # MinIO - S3-compatible object storage
    minio:
        image: minio/minio:latest
        container_name: pet-platform-minio
        environment:
            MINIO_ROOT_USER: petadmin
            MINIO_ROOT_PASSWORD: petpass123
        ports:
            - "9000:9000"
            - "9001:9001"
        volumes:
            - minio_data:/data
        networks:
            - pet-network
        command: server /data --console-address ":9001"
        healthcheck:
            test:
                ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            interval: 30s
            timeout: 20s
            retries: 3

networks:
    pet-network:
        driver: bridge

volumes:
    postgres_data:
    mongo_data:
    redis_data:
    rabbitmq_data:
    elasticsearch_data:
    minio_data:
